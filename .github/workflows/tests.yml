name: ğŸš€ CI/CD - Rest Assured Tests + Backend GameStore

# ========================================
# QUANDO EXECUTAR O PIPELINE
# ========================================
on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  # ========================================
  # JOB PRINCIPAL: TESTAR API COM REST ASSURED
  # ========================================
  test-api:
    name: ğŸ§ª Testes Rest Assured da API GameStore
    runs-on: ubuntu-latest

    # ========================================
    # SERVIÃ‡O POSTGRESQL EM CONTAINER
    # ========================================
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: gamestore_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      # ========================================
      # STEP 1: CHECKOUT DO REPOSITÃ“RIO DE TESTES
      # ========================================
      - name: ğŸ“¥ Checkout cÃ³digo do repositÃ³rio
        uses: actions/checkout@v4

      # ========================================
      # STEP 2: SETUP NODE.JS 18
      # ========================================
      - name: ğŸŸ¢ Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Cache npm (sem especificar path se nÃ£o tiver package-lock.json commitado)

      # ========================================
      # STEP 3: INSTALAR DEPENDÃŠNCIAS DO BACKEND
      # ========================================
      - name: ğŸ“¦ Instalar dependÃªncias do Backend
        working-directory: ./Backend
        run: |
          echo "ğŸ“‹ Instalando dependÃªncias do Node.js..."
          npm install
          echo "âœ… DependÃªncias instaladas!"

      # ========================================
      # STEP 4: CONFIGURAR VARIÃVEIS DE AMBIENTE
      # ========================================
      - name: âš™ï¸  Criar arquivo .env do Backend
        working-directory: ./Backend
        run: |
          echo "ğŸ”§ Criando arquivo .env..."
          cat > .env << EOF
          DATABASE_URL=postgresql://postgres:testpassword@localhost:5432/gamestore_test
          JWT_SECRET=${{ secrets.JWT_SECRET || '6b40c450e47b529f9c300c10c4b1fd122cd53306b02c3901d19199dd3f0ba5a7' }}
          PORT=3000
          RAWG_API_KEY=${{ secrets.RAWG_API_KEY || '534f1d1eacc34f8d9194c5b73c0d7099' }}
          NODE_ENV=test
          CI=true
          DISABLE_SSL=true
          EOF
          echo "âœ… Arquivo .env criado:"
          cat .env

      # ========================================
      # STEP 5: CRIAR TABELAS NO POSTGRESQL
      # ========================================
      - name: ğŸ—„ï¸  Criar schema do banco de dados
        working-directory: ./Backend
        run: |
          echo "â³ Aguardando PostgreSQL estar totalmente pronto..."
          sleep 10
          
          echo "ğŸ” Testando conexÃ£o com PostgreSQL..."
          PGPASSWORD=testpassword psql -h localhost -U postgres -d gamestore_test -c "SELECT version();"
          
          echo ""
          echo "ğŸ“‹ Executando RECREATE-DATABASE.sql..."
          PGPASSWORD=testpassword psql -h localhost -U postgres -d gamestore_test -f RECREATE-DATABASE.sql
          
          echo ""
          echo "âœ… SQL executado! Verificando tabelas criadas..."
          PGPASSWORD=testpassword psql -h localhost -U postgres -d gamestore_test -c "\dt"
          
          echo ""
          echo "ğŸ” Verificando se tabela 'jogos' tem dados..."
          PGPASSWORD=testpassword psql -h localhost -U postgres -d gamestore_test -c "SELECT COUNT(*) as total_jogos FROM jogos;"

      # ========================================
      # STEP 6: INICIAR SERVIDOR BACKEND
      # ========================================
      - name: ğŸš€ Iniciar servidor Express
        working-directory: ./Backend
        run: |
          echo "ğŸš€ Iniciando servidor Node.js..."
          nohup npm start > backend.log 2>&1 &
          echo $! > backend.pid
          
          echo "âœ… Servidor iniciado com PID: $(cat backend.pid)"
          echo "ğŸ“‹ Aguardando inicializaÃ§Ã£o..."
          sleep 10
          
          echo "ğŸ“‹ Primeiras linhas do log:"
          head -n 20 backend.log || echo "Log ainda nÃ£o disponÃ­vel"

      # ========================================
      # STEP 7: AGUARDAR BACKEND FICAR ONLINE
      # ========================================
      - name: â³ Aguardar servidor estar online
        working-directory: ./Backend
        run: |
          echo "â³ Aguardando servidor inicializar..."
          
          # Aguardar atÃ© 60 segundos
          for i in {1..30}; do
            echo "Tentativa $i/30..."
          
            # Verificar se o processo ainda estÃ¡ rodando
            if [ -f backend.pid ]; then
              PID=$(cat backend.pid)
              if ! kill -0 $PID 2>/dev/null; then
                echo "âŒ ERRO: Servidor morreu!"
                echo "ğŸ“‹ Logs completos:"
                cat backend.log
                exit 1
              fi
            fi
          
            # Testar endpoint
            if curl -f http://localhost:3000/api/jogos 2>/dev/null; then
              echo "âœ… Backend estÃ¡ online e respondendo!"
              exit 0
            fi
          
            # Mostrar Ãºltimas linhas do log a cada 5 tentativas
            if [ $((i % 5)) -eq 0 ]; then
              echo "ğŸ“‹ Ãšltimas linhas do log:"
              tail -n 10 backend.log 2>/dev/null || echo "Log ainda vazio"
            fi
          
            sleep 2
          done
          
          echo "âŒ Timeout: Servidor nÃ£o ficou online em 60s"
          echo "ğŸ“‹ Logs completos do backend:"
          cat backend.log
          exit 1

      # ========================================
      # STEP 8: TESTAR API COM CURL (SMOKE TEST)
      # ========================================
      - name: ğŸ§ª Smoke test da API
        working-directory: ./Backend
        run: |
          echo "========================================="
          echo "ğŸ“‹ LOGS DO BACKEND ANTES DOS TESTES"
          echo "========================================="
          cat backend.log
          echo ""
          echo "========================================="
          
          echo "ğŸ§ª Testando endpoint GET /api/jogos..."
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/jogos)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "Status HTTP: $HTTP_CODE"
          echo "Resposta: $BODY"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo ""
            echo "âŒ ERRO: API retornou status $HTTP_CODE"
            echo "ğŸ“‹ Logs completos do backend:"
            cat backend.log
            exit 1
          fi
          
          echo ""
          echo "ğŸ§ª Testando endpoint de autenticaÃ§Ã£o..."
          curl -X POST http://localhost:3000/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@gamestore.com","password":"123456"}' \
            -s | jq '.' || echo "Login respondeu"
          
          echo ""
          echo "âœ… Smoke tests concluÃ­dos!"

      # ========================================
      # STEP 9: SETUP JAVA 17 + MAVEN
      # ========================================
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      # ========================================
      # STEP 10: EXECUTAR TESTES REST ASSURED
      # ========================================
      - name: ğŸ§ª Executar testes Rest Assured
        run: |
          echo "ğŸ“‹ Iniciando testes Rest Assured..."
          echo "ğŸ“ DiretÃ³rio atual: $(pwd)"
          echo "ğŸ“‚ ConteÃºdo do diretÃ³rio:"
          ls -la
          
          if [ -f "pom.xml" ]; then
            echo "âœ… pom.xml encontrado!"
            echo "ğŸ§ª Executando: mvn clean test"
            mvn clean test \
              -Dtest.api.baseUrl=http://localhost:3000 \
              -Dtest.api.url=http://localhost:3000 \
              -DbaseUrl=http://localhost:3000
          
            echo "âœ… Testes concluÃ­dos!"
          else
            echo "âŒ ERRO: pom.xml nÃ£o encontrado!"
            echo "ğŸ“‚ Estrutura do repositÃ³rio:"
            find . -name "pom.xml" -o -name "*.java"
            exit 1
          fi
        continue-on-error: false

      # ========================================
      # STEP 11: GERAR RELATÃ“RIO ALLURE
      # ========================================
      - name: ğŸ“Š Gerar relatÃ³rio Allure
        if: always()
        run: |
          if [ -d "target/allure-results" ]; then
            echo "ğŸ“Š Gerando relatÃ³rio Allure..."
            npm install -g allure-commandline
            allure generate target/allure-results -o target/allure-report --clean
            echo "âœ… RelatÃ³rio Allure gerado em target/allure-report/"
          else
            echo "âš ï¸  DiretÃ³rio target/allure-results nÃ£o encontrado"
            echo "ğŸ“‚ ConteÃºdo de target/:"
            ls -la target/ || echo "Pasta target/ nÃ£o existe"
          fi
        continue-on-error: true

      # ========================================
      # STEP 12: UPLOAD RELATÃ“RIO ALLURE
      # ========================================
      - name: ğŸ“¤ Upload relatÃ³rio Allure
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ github.run_number }}
          path: target/allure-report/
          if-no-files-found: warn
          retention-days: 30

      # ========================================
      # STEP 13: UPLOAD SUREFIRE REPORTS
      # ========================================
      - name: ğŸ“¤ Upload Surefire reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports-${{ github.run_number }}
          path: target/surefire-reports/
          if-no-files-found: warn
          retention-days: 15

      # ========================================
      # STEP 14: UPLOAD LOGS DO BACKEND
      # ========================================
      - name: ğŸ“¤ Upload logs do Backend
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-logs-${{ github.run_number }}
          path: Backend/backend.log
          if-no-files-found: warn
          retention-days: 7

      # ========================================
      # STEP 15: MOSTRAR LOGS EM CASO DE FALHA
      # ========================================
      - name: ğŸ“‹ Mostrar logs do backend (se falhou)
        if: failure()
        working-directory: ./Backend
        run: |
          echo "========================================="
          echo "ğŸ“‹ LOGS DO SERVIDOR BACKEND"
          echo "========================================="
          if [ -f backend.log ]; then
            tail -n 100 backend.log
          else
            echo "âš ï¸  Arquivo backend.log nÃ£o encontrado"
          fi

      # ========================================
      # STEP 16: PARAR SERVIDOR BACKEND
      # ========================================
      - name: ğŸ›‘ Parar servidor Backend
        if: always()
        working-directory: ./Backend
        run: |
          if [ -f backend.pid ]; then
            PID=$(cat backend.pid)
            echo "ğŸ›‘ Parando servidor com PID: $PID"
            kill $PID || true
            sleep 2
            kill -9 $PID 2>/dev/null || true
            rm -f backend.pid
            echo "âœ… Servidor parado"
          else
            echo "âš ï¸  Arquivo backend.pid nÃ£o encontrado"
            echo "ğŸ” Tentando encontrar processo Node.js..."
            pkill -f "node.*server.js" || echo "Nenhum processo encontrado"
          fi

      # ========================================
      # STEP 17: SUMMARY DOS TESTES
      # ========================================
      - name: ğŸ“Š Summary dos testes
        if: always()
        run: |
          echo "========================================="
          echo "ğŸ“Š RESUMO DA EXECUÃ‡ÃƒO"
          echo "========================================="
          echo "ğŸƒ Run Number: ${{ github.run_number }}"
          echo "ğŸ“… Data: $(date)"
          echo "ğŸ”— RepositÃ³rio: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "========================================="
