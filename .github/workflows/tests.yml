name: CI/CD Pipeline - GameStore Backend + Testes Rest Assured

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  test-backend:
    name: ğŸ§ª Testes Backend + Rest Assured
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: gamestore_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # Checkout
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      # Node.js
      - name: ğŸŸ¢ Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: Backend/package-lock.json

      # Instalar dependÃªncias do backend
      - name: ğŸ“¦ Instalar dependÃªncias do Backend
        working-directory: ./Backend
        run: npm ci

      # Criar .env
      - name: âš™ï¸ Criar arquivo .env
        working-directory: ./Backend
        run: |
          echo "DATABASE_URL=postgresql://postgres:testpassword@localhost:5432/gamestore_test" > .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET || 'ci-secret-key' }}" >> .env
          echo "PORT=3000" >> .env
          echo "RAWG_API_KEY=${{ secrets.RAWG_API_KEY || '' }}" >> .env
          cat .env

      # Criar tabelas SQL
      - name: ğŸ—„ï¸ Criar Tabelas no PostgreSQL
        working-directory: ./Backend
        run: |
          sleep 5
          PGPASSWORD=testpassword psql -h localhost -U postgres -d gamestore_test -f RECREATE-DATABASE.sql

      # Start backend
      - name: ğŸš€ Iniciar Backend
        working-directory: ./Backend
        run: |
          nohup npm start > backend.log 2>&1 &
          echo $! > backend.pid
          echo "Backend iniciado com PID: $(cat backend.pid)"

      # Esperar API ficar online
      - name: â³ Aguardar backend subir
        run: |
          npm install -g wait-on
          wait-on http://localhost:3000/api/jogos
          echo "Servidor estÃ¡ online!"

      # Setup Java
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      # Executar testes REST Assured
      - name: ğŸ§ª Executar testes Rest Assured
        run: mvn clean test -Dtest.api.url=http://localhost:3000
        continue-on-error: false

      # Gerar Allure
      - name: ğŸ“Š Gerar Allure Report
        if: always()
        run: |
          if [ -d "target/allure-results" ]; then
            npm install -g allure-commandline --unsafe-perm=true
            allure generate target/allure-results -o target/allure-report --clean
          else
            echo "âš  Nenhum resultado do Allure encontrado."
          fi
        continue-on-error: true

      # Upload Allure report
      - name: ğŸ“¤ Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: target/allure-report
          retention-days: 30

      # Upload logs do backend quando falhar
      - name: ğŸ“¤ Upload logs do backend
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-logs
          path: Backend/backend.log
          retention-days: 7

      # Finalizar servidor
      - name: ğŸ›‘ Parar servidor Backend
        if: always()
        working-directory: ./Backend
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) || true
            rm backend.pid
            echo "Servidor parado"
          fi